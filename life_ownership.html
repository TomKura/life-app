
<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="UTF-8" />
  <title>Life Ownership Prototype v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ... æ—¢å­˜ã®CSSï¼ˆçœç•¥ï¼‰ ... */

/* Calendar - Day Mode ã®æ–°ã—ã„ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º (v9) */

/* å¾“æ¥ã®æ¨ªä¸¦ã³ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯HTMLã‹ã‚‰å‰Šé™¤ã™ã‚‹ã‹éè¡¨ç¤ºã«ã™ã¹ãã§ã™ãŒã€
   ã‚‚ã—å¤ã„HTMLè¦ç´ ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ã“ã®CSSã§éè¡¨ç¤ºã«ã—ã¾ã™ */
.timeline-rows-wrapper {
    display: none; 
}

/* ç¸¦å‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ã®Gridã‚³ãƒ³ãƒ†ãƒŠ */
.schedule-view-wrapper {
    display: grid;
    grid-template-columns: 50px 1fr; /* ã‚¿ã‚¤ãƒ ãƒ©ãƒ™ãƒ«ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */
    gap: 0;
    margin-top: 10px;
    border: 1px solid var(--card);
    border-radius: 6px;
    max-height: 80vh; /* ç”»é¢ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´ */
    overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ timeline-col ã®ã¿ */
}

/* æ™‚é–“ãƒ©ãƒ™ãƒ«ã®åˆ— */
.hour-labels-col {
    /* 24æ™‚é–“åˆ†ã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
    display: grid;
    grid-template-rows: repeat(24, 1fr); 
    border-right: 1px solid var(--card);
    height: 100%;
    /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ—ã¨ä¸€ç·’ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚ã®èª¿æ•´ */
}

.hour-label-block {
    font-size: 10px;
    color: var(--text-muted);
    text-align: right;
    padding-right: 4px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    /* 1æ™‚é–“ã”ã¨ã®åŒºåˆ‡ã‚Šç·š */
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1); 
    /* grid-row: 1 / span 12; ã®ã‚ˆã†ã«HTMLå´ã§ä½ç½®ã‚’èª¿æ•´ */
}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã®åˆ—ï¼ˆ288è¡Œã‚°ãƒªãƒƒãƒ‰ï¼‰ */
.schedule-timeline-col {
    /* 5åˆ†åˆ»ã¿ã§288è¡Œã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
    display: grid;
    /* 1fr ã§å…¨è¡Œã«å‡ç­‰ãªæ¯”ç‡ã‚’é©ç”¨ */
    grid-template-rows: repeat(288, minmax(1px, 1fr)); 
    overflow-y: auto; /* ã“ã“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ */
    min-height: 600px; /* è¦‹ã‚„ã™ã•ã®ãŸã‚ã®æœ€ä½é«˜ */
}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ */
.schedule-block {
    cursor: pointer;
    padding: 4px 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    /* ãƒ–ãƒ­ãƒƒã‚¯é–“ã®åŒºåˆ‡ã‚Šç·š */
    border-bottom: 1px solid var(--card); 
    transition: background 0.1s;
    font-size: 12px;
    grid-column: 1; /* 1åˆ—ç›®ã‚’ä½¿ç”¨ */
    /* grid-row: start / end; ã¯HTMLå´ã§å‹•çš„ã«è¨­å®š */
}

.schedule-block.empty {
    background: var(--card) !important;
    color: var(--text-muted);
    font-style: italic;
    min-height: 15px; /* æœ€ä½ã®é«˜ã• */
}

.schedule-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.schedule-block.empty .schedule-text {
    justify-content: center;
}

.schedule-time {
    font-size: 9px;
    opacity: 0.7;
}

/* ... æ—¢å­˜ã®CSSï¼ˆçœç•¥ï¼‰ ... */
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #38bdf8;
      --accent-soft: #0f766e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1f2933, #020617);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }
    header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    header span {
      font-size: 11px;
      color: var(--text-muted);
    }
    main {
      flex: 1;
      padding: 8px 12px 56px;
      overflow-y: auto;
    }
    .card {
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 10px;
      border: 1px solid rgba(148,163,184,0.28);
      box-shadow: 0 16px 30px rgba(15,23,42,0.8);
    }
    .card h2 {
      font-size: 14px;
      margin-bottom: 6px;
    }
    .ownership-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }
    .ownership-main {
      font-size: 28px;
      font-weight: 700;
    }
    .muted {
      font-size: 11px;
      color: var(--text-muted);
    }
    .tagline {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 3px 8px;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    /* Tabs */
    .tab-bar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 6px;
      width: 100%;
      max-width: 480px;
      padding: 4px 10px;
      z-index: 20;
    }
    .tab-inner {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 20px 35px rgba(15,23,42,0.9);
      padding: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 4px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      border-radius: 999px;
      cursor: pointer;
    }
    .tab-btn span.icon {
      font-size: 16px;
    }
    .tab-btn.active {
      color: var(--accent);
      background: rgba(56,189,248,0.10);
    }
    /* Calendar */
    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .month-header button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 4px;
    }
    .month-header-title {
      font-size: 14px;
      font-weight: 600;
    }
    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 4px;
    }
    .weekday {
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .day-cell {
      height: 48px;
      border-radius: 10px;
      padding: 2px 3px;
      font-size: 10px;
      cursor: pointer;
      position: relative;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(30,64,175,0.4);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .day-cell.empty {
      border: none;
      background: transparent;
      cursor: default;
    }
    .day-number {
      font-size: 10px;
      opacity: 0.9;
    }
    .day-ownership {
      font-size: 9px;
      opacity: 0.9;
    }
    .today-outline {
      outline: 1px solid var(--accent);
      outline-offset: -1px;
    }
    .view-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
      margin-bottom: 6px;
    }
    .view-toggle button {
      border: none;
      padding: 4px 10px;
      font-size: 10px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }
    .view-toggle button.active {
      background: rgba(56,189,248,0.15);
      color: var(--accent);
    }
    /* Day timeline */
    .day-timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .day-nav-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 4px;
    }
    .category-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    .category-chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 2px 8px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: transparent;
      color: var(--text-muted);
    }
    .category-color-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .category-chip.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(56,189,248,0.12);
    }
    .timeline-rows-wrapper {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .timeline-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }
    .timeline-row-label {
      width: 34px;
      font-size: 10px;
      text-align: right;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .timeline-row-bar {
      flex: 1;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.5);
      padding: 2px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1px;
    }
    .timeline-block {
      height: 14px;
      border-radius: 6px;
      background: rgba(15,23,42,0.9);
      cursor: pointer;
    }
    .timeline-block.active {
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
    }
    .range-select-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .range-select-row select {
      font-size: 10px;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: var(--text-main);
    }
    /* Day detail sheet */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 30;
    }
    .sheet {
      background: #020617;
      width: 100%;
      max-width: 480px;
      border-radius: 18px 18px 0 0;
      padding: 10px 14px 16px;
      box-shadow: 0 -20px 40px rgba(0,0,0,0.8);
      max-height: 90vh;
      overflow-y: auto;
    }
    .sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148,163,184,0.6);
      margin: 0 auto 8px;
    }
    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .sheet-header h3 {
      font-size: 14px;
    }
    .sheet-close {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
    }
    .field-label {
      font-size: 11px;
      margin-top: 6px;
      margin-bottom: 2px;
      color: var(--text-muted);
    }
    .headline-input,
    .memo-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4);
      background: #020617;
      color: var(--text-main);
      font-size: 11px;
      resize: vertical;
    }
    .headline-input {
      height: 28px;
    }
    .memo-input {
      min-height: 40px;
    }
    .save-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: var(--accent);
      color: #0b1120;
      font-weight: 600;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(0, 0, 0, 0);
    }
    .range-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input[type="range"] {
      flex: 1;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    /* Stats & chart */
    .center-note {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 24px;
      line-height: 1.6;
    }
    .stats-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .stats-nav-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 4px;
    }
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 120px;
      margin-top: 8px;
    }
    .bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 3px;
    }
    .bar {
      width: 70%;
      border-radius: 6px 6px 0 0;
      background: #38bdf8;
    }
    .bar-label {
      font-size: 9px;
      color: var(--text-muted);
    }
    .bar-percent {
      font-size: 9px;
    }
    /* Logs */
    .log-card {
      cursor: pointer;
    }
    .log-headline-input {
      margin-top: 4px;
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: var(--text-main);
      font-size: 11px;
    }
    /* Focus timer */
    .timer-display {
      font-variant-numeric: tabular-nums;
      font-size: 22px;
      font-weight: 600;
    }
    .timer-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .pomodoro-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .pomodoro-row input {
      width: 40px;
      font-size: 11px;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: var(--text-main);
    }
    .focus-label-input {
      margin-top: 6px;
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: var(--text-main);
      font-size: 11px;
    }
    /* ... æ—¢å­˜ã®CSSï¼ˆçœç•¥ï¼‰ ... */

/* Day Sheet ç”¨ã®è©•ä¾¡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.rating-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
}

.rating-row input[type="range"] {
    flex-grow: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    background: var(--card);
    border-radius: 4px;
    cursor: pointer;
}

.rating-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
}
.rating-label {
    font-weight: bold;
    color: var(--accent);
    width: 20px;
    text-align: right;
}

/* Calendar - Day Mode ã®æ–°ã—ã„ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º (v10) */

.schedule-view-wrapper {
    display: grid;
    grid-template-columns: 50px 1fr; /* ã‚¿ã‚¤ãƒ ãƒ©ãƒ™ãƒ«ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */
    gap: 0;
    margin-top: 10px;
    border: 1px solid var(--card);
    border-radius: 6px;
    /* max-height: 80vh; ã¯ä¸è¦ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä¸­èº«ãŒè¡Œã†ï¼‰ */
    overflow: hidden; 
}

/* æ™‚é–“ãƒ©ãƒ™ãƒ«ã®åˆ— */
.hour-labels-col {
    /* 24æ™‚é–“åˆ†ã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
    display: grid;
    /* minmax(50px, auto) ã«ã—ã¦æ™‚é–“è»¸ã®æœ€ä½é«˜ã‚’ç¢ºä¿ */
    grid-template-rows: repeat(24, minmax(50px, auto)); 
    border-right: 1px solid var(--card);
    /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ—ã¨åŒã˜é«˜ã•ã«ã™ã‚‹ãŸã‚ã®èª¿æ•´ */
    align-items: stretch;
    position: sticky; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚æ™‚é–“è»¸ã‚’å·¦ç«¯ã«å›ºå®šã™ã‚‹ */
    top: 0;
    z-index: 10;
    background: var(--bg); /* å›ºå®šã•ã‚ŒãŸæ™‚é–“è»¸ã®èƒŒæ™¯è‰² */
}

.hour-label-block {
    font-size: 10px;
    color: var(--text-muted);
    text-align: right;
    padding-right: 4px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    /* 1æ™‚é–“ã”ã¨ã®åŒºåˆ‡ã‚Šç·š */
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1); 
    height: 50px; /* 5åˆ†åˆ»ã¿ï¼ˆ288è¡Œï¼‰ã®å ´åˆã€1æ™‚é–“=12è¡Œãªã®ã§ 12 * 4.16px ãã‚‰ã„ã«ãªã‚‹ãŒã€ä»Šå›ã¯ minmax(1px, 1fr) ãªã®ã§CSSèª¿æ•´ãŒé›£ã—ã„ã€‚Hour Labelã¯å›ºå®šè¡Œã‚’ä½¿ã†ã€‚*/
    
    /* NEW: Hour-labels-colã¯24è¡Œã€‚schedule-timeline-colã¯288è¡Œã€‚
    Hour-labels-colã®å„è¡Œã®é«˜ã•ã¯ã€schedule-timeline-colã®12è¡Œåˆ†ã®é«˜ã•ã¨åŒæœŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    ã“ã‚Œã¯HTMLã® grid-row: X / span 12 ã§è§£æ±ºã—ã¦ã„ã¾ã™ã€‚CSSã§ã¯ã“ã‚Œä»¥ä¸Šã®èª¿æ•´ã¯ä¸è¦ã§ã™ã€‚ */
}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã®åˆ—ï¼ˆ288è¡Œã‚°ãƒªãƒƒãƒ‰ï¼‰ */
.schedule-timeline-col {
    display: grid;
    grid-template-rows: repeat(288, 1fr); /* 5åˆ†åˆ»ã¿ã§288è¡Œã®ã‚°ãƒªãƒƒãƒ‰ã‚’ä½œæˆ */
    overflow-y: auto; /* â˜…NEW: ã“ã“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ â˜… */
    /* ç”»é¢é«˜ã•å…¨ä½“ã‚’ä½¿ã†ã‚ˆã†ã«èª¿æ•´ */
    height: 70vh; 
    min-height: 400px;
}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ */
.schedule-block {
    cursor: pointer;
    padding: 4px 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-bottom: 1px solid var(--card); 
    transition: background 0.1s;
    font-size: 12px;
    grid-column: 1; 
    /* çµåˆã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã¯æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ */
    min-height: 1px; 
}

.schedule-block.empty {
    background: var(--card) !important;
    color: var(--text-muted);
    font-style: italic;
    /* min-height ã¯ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ãƒ”ã‚¯ã‚»ãƒ«æŒ‡å®šã¯ä¸è¦ */
}

/* ... æ—¢å­˜ã®CSSï¼ˆçœç•¥ï¼‰ ... */
  
/* === v7 overrides: calendar day view scroll sync === */
.schedule-view-wrapper {
    display: grid;
    grid-template-columns: 50px 1fr;
    gap: 0;
    margin-top: 10px;
    border: 1px solid var(--card);
    border-radius: 6px;
    height: 70vh;
    overflow-y: auto; /* scroll both time column and schedule together */
}

.hour-labels-col {
    position: static;           /* no sticky; scrolls with timeline */
}

.schedule-timeline-col {
    overflow-y: visible;        /* parent handles scrolling */
}


/* === v7 compat override: unify day grid rows for hour labels & schedule === */
.schedule-view-wrapper {
    display: grid;
    grid-template-columns: 50px 1fr;
    grid-template-rows: repeat(288, minmax(4px, 1fr)); /* 5åˆ†åˆ»ã¿ 288è¡Œã‚’ã“ã“ã§å®šç¾© */
    height: 70vh;
    overflow-y: auto; /* ãƒ©ãƒ™ãƒ«ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã‚‚ä¸€ç·’ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}

/* å­ã‚³ãƒ³ãƒ†ãƒŠã¯ã€Œä¸­èº«ã ã‘ã€ã‚’ã‚°ãƒªãƒƒãƒ‰ã«ä¹—ã›ã‚‹ */
.hour-labels-col,
.schedule-timeline-col {
    display: contents;           /* è‡ªèº«ã¯æ¶ˆãˆã€ä¸­ã®è¦ç´ ãŒ .schedule-view-wrapper ã®ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã«ãªã‚‹ */
}

/* æ™‚é–“ãƒ©ãƒ™ãƒ«ã¯1åˆ—ç›®ã«é…ç½®ã—ã€1æ™‚é–“=12ãƒã‚¹ã¶ã‚“ã‚’å æœ‰ */
.hour-label-block {
    grid-column: 1;
    border-right: 1px solid var(--card);
}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã¯2åˆ—ç›®ã«é…ç½® */
.schedule-block {
    grid-column: 2;
}

</style>
</head>
<body>
  <div id="app">
    <header>
      <div>
        <h1 id="header-title">Calendar</h1>
        <span id="header-sub">24æ™‚é–“ã®ã€Œä½¿ã„æ–¹ã€ã‚’è¦‹ãˆã‚‹åŒ–</span>
      </div>
      <span id="header-score" class="muted"></span>
    </header>
    <button id="saveButton" class="btn btn-primary" style="margin: 10px 12px; display: block; width: calc(100% - 24px);">
      âš¡ ãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ä¿å­˜ï¼ˆãƒ†ã‚¹ãƒˆï¼‰
    </button>
    <main id="main"></main>

    <div class="tab-bar">
      <div class="tab-inner">
        <button class="tab-btn" data-tab="today">
          <span class="icon">â˜€ï¸</span>
          <span>Today</span>
        </button>
        <button class="tab-btn active" data-tab="calendar">
          <span class="icon">ğŸ“…</span>
          <span>Calendar</span>
        </button>
        <button class="tab-btn" data-tab="stats">
          <span class="icon">ğŸ“Š</span>
          <span>Stats</span>
        </button>
        <button class="tab-btn" data-tab="logs">
          <span class="icon">ğŸ“</span>
          <span>Logs</span>
        </button>
        <button class="tab-btn" data-tab="settings">
          <span class="icon">âš™ï¸</span>
          <span>Settings</span>
        </button>
      </div>
    </div>
  </div>

<script>
    // =======================================================
    // ======== Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– (1/10) - å¤‰æ›´ãªã— ========
    // =======================================================
    // ã‚ãªãŸã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®URLã¨ã‚­ãƒ¼ã‚’è¨­å®šæ¸ˆã¿
    const SUPABASE_URL = 'https://dkyflkdukxsnqkmvmsuo.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRreWZsa2R1a3hzbnFrbXZtc3VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDcwMTcsImV4cCI6MjA3OTQ4MzAxN30.Z8mmOFEfDrbIu81QK8_cLDxeznMAIrTpI7Zc2BanBss'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 
    // =======================================================

    const STORAGE_KEY_DAYS = "lifeOwnership_v1_days";
    const STORAGE_KEY_CATS = "lifeOwnership_v1_categories";
    const STORAGE_KEY_RECURRING = "lifeOwnership_v1_recurring"; 
    const STORAGE_KEY_CRITERIA = "lifeOwnership_v1_criteria"; // â˜…NEWâ˜…

    // â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«å½±éŸ¿ã•ã‚Œãªã„ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç”Ÿæˆ â˜…â˜…â˜…
    function ymd(date) {
        const y = date.getFullYear();
        // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ +1
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
    
    function stripTime(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }
    function hmToIndex(h, m) {
        return h * 12 + Math.floor(m / 5);
    }

    // =======================================================
    // ======== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•° (2/10) - ã‚¯ãƒ©ã‚¦ãƒ‰å–å¾— ========
    // =======================================================
    async function fetchDaysFromSupabase() {
        const TIMEOUT_MS = 10000; 
        const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Supabase fetch timeout (10s)')), TIMEOUT_MS)
        );

        const fetchPromise = async () => {
            console.log("Supabaseã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
            const { data, error } = await supabase
                .from('daily_logs')
                .select('log_date, data'); 
            if (error) throw error;
            return data;
        };

        try {
            const data = await Promise.race([fetchPromise(), timeoutPromise]);
            if (!data || data.length === 0) {
                console.log("Supabaseã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                return {};
            }
            const cloudDays = {};
            data.forEach(row => {
                cloudDays[row.log_date] = {
                    ...row.data,
                    date: row.log_date 
                };
            });
            console.log(`Supabaseã‹ã‚‰ ${data.length} æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚`);
            return cloudDays;
        } catch (error) {
            console.error('Supabaseã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
            return {};
        }
    }
    // =======================================================

    // =======================================================
    // ======== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•° (3/10) - ãƒ­ãƒ¼ã‚«ãƒ«/ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒ¼ã‚¸ ========
    // =======================================================
    async function loadDays() {
      let localDays = {};
      try {
        const raw = localStorage.getItem(STORAGE_KEY_DAYS);
        if (raw) {
            localDays = JSON.parse(raw);
            console.log(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ ${Object.keys(localDays).length} æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
        }
      } catch (e) {
        console.error("ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
      }
      
      const cloudDays = await fetchDaysFromSupabase();
      const mergedDays = {
          ...localDays,
          ...cloudDays
      };
      saveDays(mergedDays);

      return mergedDays;
    }
    // =======================================================

    function saveDays(daysObj) {
      try {
        localStorage.setItem(STORAGE_KEY_DAYS, JSON.stringify(daysObj));
        console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚"); 
      } catch (e) {
        console.error("saveDays error", e);
      }
    }

    function defaultCategories() {
      return [
        { id: "study", name: "å‹‰å¼·", color: "#38bdf8" }, 
        { id: "phone", name: "ã‚¹ãƒãƒ›", color: "#fb7185" }, 
        { id: "other", name: "ãã®ä»–", color: "#4ade80" }
      ];
    }
    
    
    
    function loadCategories() {
      // ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚€
      let localCats;
      try {
        const raw = localStorage.getItem(STORAGE_KEY_CATS);
        if (!raw) {
          localCats = defaultCategories();
        } else {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || !parsed.length) {
            localCats = defaultCategories();
          } else {
            // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›: budgetSecondsãªã©ä¸è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰Šé™¤ã—ã€sortOrderã‚’è£œå®Œ
            localCats = parsed.map((c, idx) => {
              const clone = (c && typeof c === "object") ? { ...c } : { id: `cat_${idx}`, name: `ã‚«ãƒ†ã‚´ãƒª${idx + 1}`, color: "#38bdf8" };
              delete clone.budgetSeconds;
              if (typeof clone.sortOrder !== "number") clone.sortOrder = idx;
              return clone;
            });
          }
        }
      } catch (e) {
        console.error("loadCategories local error", e);
        localCats = defaultCategories().map((c, idx) => ({ ...c, sortOrder: idx }));
      }

      // éåŒæœŸã§Supabaseã‹ã‚‰ã®æœ€æ–°ç‰ˆã‚’å–å¾—ã—ã€ã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã¦ state ã«åæ˜ 
      (async () => {
        try {
          const { data, error } = await supabase
            .from('categories')
            .select('id, name, color, sort_order')
            .order('sort_order', { ascending: true })
            .order('id', { ascending: true });

          if (error) {
            console.warn("Supabase categories fetch error:", error.message);
            return;
          }
          if (!data || !data.length) {
            // ã‚¯ãƒ©ã‚¦ãƒ‰å´ã«ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ãã®ã¾ã¾ä½¿ã†
            return;
          }

          const cloudCats = data.map((row, idx) => ({
            id: row.id,
            name: row.name,
            color: row.color || '#38bdf8',
            sortOrder: typeof row.sort_order === "number" ? row.sort_order : idx
          })).sort((a, b) => a.sortOrder - b.sortOrder);

          if (typeof state !== "undefined") {
            state.categories = cloudCats;
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°
            try {
              localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(cloudCats));
            } catch (e) {
              console.error("saveCategories local (from cloud) error", e);
            }
            // ç”»é¢ã‚’å†æç”»ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼/Today/Settings ã‚ãŸã‚Šã§å½±éŸ¿ï¼‰
            if (state.currentTab === 'calendar' || state.currentTab === 'today' || state.currentTab === 'settings') {
              render();
            }
          }
        } catch (e) {
          console.error("Supabase categories fetch unexpected error:", e);
        }
      })();

      return localCats;
    }



    
    
    function saveCategories(cats) {
      if (!Array.isArray(cats)) return;

      // ä¸¦ã³é † = sortOrder ã¨ã—ã¦æ­£è¦åŒ–
      const normalized = cats.map((c, index) => ({
        ...c,
        sortOrder: index
      }));

      // state ã‚‚æ›´æ–°
      if (typeof state !== "undefined") {
        state.categories = normalized;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
      try {
        localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(normalized));
      } catch (e) {
        console.error("saveCategories local error", e);
      }

      // Supabaseã«ã‚‚åŒæœŸï¼ˆéåŒæœŸã§ fire-and-forgetï¼‰
      (async () => {
        try {
          const payloads = (normalized || []).map(c => ({
            id: c.id,
            name: c.name,
            color: c.color,
            sort_order: c.sortOrder
          }));
          if (!payloads.length) return;

          const { error } = await supabase
            .from('categories')
            .upsert(payloads, { onConflict: 'id' });

          if (error) {
            console.error("saveCategories Supabase error:", error.message);
          } else {
            console.log(`Supabase categories updated: ${payloads.length}ä»¶`);
          }
        } catch (e) {
          console.error("saveCategories Supabase unexpected error:", e);
        }
      })();
    }



    // â˜…â˜…â˜… NEW: æŒ¯ã‚Šè¿”ã‚ŠåŸºæº–ã®ãƒ­ãƒ¼ãƒ‰/ã‚»ãƒ¼ãƒ– â˜…â˜…â˜…
    function defaultReviewCriteria() {
      return [
        { id: "c1", name: "è‡ªå·±æ±ºå®šåº¦" }, 
        { id: "c2", name: "æ´»å‹•å……å®Ÿåº¦" }, 
        { id: "c3", name: "å¿ƒèº«ã®èª¿å­" }
      ];
    }

    
    function loadReviewCriteria() {
      let criteria;
      try {
        const raw = localStorage.getItem(STORAGE_KEY_CRITERIA);
        if (!raw) {
          criteria = defaultReviewCriteria();
        } else {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || parsed.length === 0) {
            criteria = defaultReviewCriteria();
          } else {
            criteria = parsed.slice(0, 3);
            while (criteria.length < 3) {
              criteria.push({ id: `c${criteria.length + 1}`, name: `åŸºæº–${criteria.length + 1}` });
            }
          }
        }
      } catch (e) {
        console.error("loadReviewCriteria local error", e);
        criteria = defaultReviewCriteria();
      }

      // Supabase ã‹ã‚‰ã®åŒæœŸï¼ˆéåŒæœŸï¼‰ã€‚æ—¥ã€…ã®æŒ¯ã‚Šè¿”ã‚ŠåŸºæº–ã‚’å…¨ç«¯æœ«ã§å…±é€šåŒ–ã€‚
      (async () => {
        try {
          const { data, error } = await supabase
            .from('review_criteria')
            .select('id, name, sort_order')
            .order('sort_order', { ascending: true });

          if (error) {
            console.warn("Supabase review_criteria fetch error:", error.message);
            return;
          }
          if (!data || !data.length) return;

          const cloud = data.map((row, idx) => ({
            id: row.id || `c${idx + 1}`,
            name: row.name || `åŸºæº–${idx + 1}`
          }));
          while (cloud.length < 3) {
            cloud.push({ id: `c${cloud.length + 1}`, name: `åŸºæº–${cloud.length + 1}` });
          }
          cloud.splice(3);

          if (typeof state !== "undefined") {
            state.reviewCriteria = cloud;
            try {
              localStorage.setItem(STORAGE_KEY_CRITERIA, JSON.stringify(cloud));
            } catch (e) {
              console.error("saveReviewCriteria local (from cloud) error", e);
            }
            if (state.currentTab === 'today' || state.currentTab === 'calendar' || state.currentTab === 'settings') {
              render();
            }
          }
        } catch (e) {
          console.error("Supabase review_criteria fetch unexpected error:", e);
        }
      })();

      return criteria;
    }


    
    function saveReviewCriteria(criteria) {
      // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
      try {
        localStorage.setItem(STORAGE_KEY_CRITERIA, JSON.stringify(criteria));
      } catch (e) {
        console.error("saveReviewCriteria local error", e);
      }

      // Supabase ã¸åŒæœŸ
      (async () => {
        try {
          const payloads = (criteria || []).map((c, index) => ({
            id: c.id || `c${index + 1}`,
            name: c.name,
            sort_order: index
          }));
          if (!payloads.length) return;

          const { error } = await supabase
            .from('review_criteria')
            .upsert(payloads, { onConflict: 'id' });

          if (error) {
            console.error("saveReviewCriteria Supabase error:", error.message);
          } else {
            console.log(`Supabase review_criteria updated: ${payloads.length}ä»¶`);
          }
        } catch (e) {
          console.error("saveReviewCriteria Supabase unexpected error:", e);
        }
      })();
    }

    // â˜…â˜…â˜… END NEW â˜…â˜…â˜…

    
    function loadRecurringLogs() {
      let localLogs = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY_RECURRING);
        localLogs = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("loadRecurringLogs local error", e);
        localLogs = [];
      }

      // Supabase ã‹ã‚‰ç¹°ã‚Šè¿”ã—äºˆå®šã‚’å–å¾—ã—ã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
      (async () => {
        try {
          const { data, error } = await supabase
            .from('recurring_logs')
            .select('id, cat_id, days, start_idx, end_idx, label')
            .order('id', { ascending: true });

          if (error) {
            console.warn("Supabase recurring_logs fetch error:", error.message);
            return;
          }
          if (!data) return;

          const cloudLogs = data.map(row => ({
            id: row.id,
            catId: row.cat_id,
            days: row.days || [],
            startIdx: row.start_idx,
            endIdx: row.end_idx,
            label: row.label || ''
          }));

          if (typeof state !== "undefined") {
            state.recurringLogs = cloudLogs;
            try {
              localStorage.setItem(STORAGE_KEY_RECURRING, JSON.stringify(cloudLogs));
            } catch (e) {
              console.error("saveRecurringLogs local (from cloud) error", e);
            }
            if (state.currentTab === 'calendar' || state.currentTab === 'settings') {
              render();
            }
          }
        } catch (e) {
          console.error("Supabase recurring_logs fetch unexpected error:", e);
        }
      })();

      return localLogs;
    }


    
    function saveRecurringLogs(logs) {
      // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
      try {
        localStorage.setItem(STORAGE_KEY_RECURRING, JSON.stringify(logs));
        console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç¹°ã‚Šè¿”ã—ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error("saveRecurringLogs local error", e);
      }

      // Supabase åŒæœŸ
      (async () => {
        try {
          const payloads = (logs || []).map(l => ({
            id: l.id,
            cat_id: l.catId,
            days: l.days,
            start_idx: l.startIdx,
            end_idx: l.endIdx,
            label: l.label || ''
          }));
          // ç©ºã®å ´åˆã¯å‰Šé™¤ã§ã‚‚ã‚ˆã„ãŒã€ã¨ã‚Šã‚ãˆãšä½•ã‚‚ã—ãªã„
          if (!payloads.length) return;

          const { error } = await supabase
            .from('recurring_logs')
            .upsert(payloads, { onConflict: 'id' });

          if (error) {
            console.error("saveRecurringLogs Supabase error:", error.message);
          } else {
            console.log(`Supabase recurring_logs updated: ${payloads.length}ä»¶`);
          }
        } catch (e) {
          console.error("saveRecurringLogs Supabase unexpected error:", e);
        }
      })();
    }


    function defaultDayData(dateStr) {
      return {
        date: dateStr,
        // ownership: null, // REMOVED
        ratings: Array(3).fill(3), // â˜…NEW: 3 criteria, default 3/5
        headline: "",
        memo1: "",
        memo2: "",
        memosExtra: [],
        focusSeconds: 0,
        focusLogs: [],
        timeline: Array(288).fill(null)
      };
    }

    function withDefaults(raw, dateStr) {
      const base = defaultDayData(dateStr);
      if (!raw) raw = base;

      // å¤ã„ ownership ã‚’å‰Šé™¤
      if (raw.ownership !== undefined) delete raw.ownership;

      if (raw.focusSeconds == null && raw.focusMinutes != null) {
        raw.focusSeconds = Math.round(raw.focusMinutes * 60);
      }
      delete raw.focusMinutes;

      if (!Array.isArray(raw.timeline) || raw.timeline.length !== 288) {
        raw.timeline = base.timeline;
      }
      
      // â˜…NEW: ratings ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (!Array.isArray(raw.ratings) || raw.ratings.length !== 3) {
          raw.ratings = base.ratings;
      }
      
      // --- ç¹°ã‚Šè¿”ã—ãƒ­ã‚°ã‚’ç©ºã„ã¦ã„ã‚‹æ ã«é©ç”¨ ---
      const d = new Date(dateStr);
      const dayOfWeek = d.getDay(); 
      
      if (state.recurringLogs && state.recurringLogs.length > 0) {
        const recurredTimeline = [...raw.timeline]; 

        state.recurringLogs.forEach(log => {
          if (log.days.includes(dayOfWeek)) {
            const startIdx = log.startIdx;
            const endIdx = Math.min(log.endIdx, 288); 
            
            for (let i = startIdx; i < endIdx; i++) {
              if (recurredTimeline[i] === null) {
                recurredTimeline[i] = log.catId;
              }
            }
          }
        });
        raw.timeline = recurredTimeline;
      }
      // --- END NEW ---
      
      return {
        ...base,
        ...raw,
        memosExtra: Array.isArray(raw.memosExtra) ? raw.memosExtra : base.memosExtra,
        focusLogs: Array.isArray(raw.focusLogs) ? raw.focusLogs : base.focusLogs,
      };
    }

    // stateã®åˆæœŸåŒ–
    const state = {
      currentTab: "calendar",
      currentDate: stripTime(new Date()),
      calendarMode: "month", 
      days: {}, 
      categories: loadCategories(),
      recurringLogs: loadRecurringLogs(), 
      reviewCriteria: loadReviewCriteria(), // â˜…NEWâ˜…
      activeCategoryId: null,
      statsPage: 0,
      pomodoroFocus: 25,
      pomodoroBreak: 5
    };
    if (!state.activeCategoryId && state.categories.length) {
      state.activeCategoryId = state.categories[0].id;
    }

    const focusTimer = {
      running: false,
      startTs: null,
      sessionSeconds: 0
    };

    const mainEl = document.getElementById("main");
    const headerTitle = document.getElementById("header-title");
    const headerSub = document.getElementById("header-sub");
    const headerScore = document.getElementById("header-score");

    let timerIntervalId = null;

    function getCategoryById(id) {
      return state.categories.find(c => c.id === id) || null;
    }

    function switchTab(tab) {
      state.currentTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      render();
    }
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    function getMonthDays(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const first = new Date(year, month, 1);
      const firstWeekday = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const days = [];
      for (let i = 0; i < firstWeekday; i++) days.push(null);
      for (let d = 1; d <= daysInMonth; d++) {
        days.push(new Date(year, month, d));
      }
      return days;
    }

    // =======================================================
    // ======== ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•° (4/10) - å˜æ—¥ä¿å­˜ç”¨ - ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° ========
    // =======================================================
    async function saveDailyData(dateStr) {
      const dayData = withDefaults(state.days[dateStr], dateStr);

      const payload = {
        log_date: dayData.date, 
        data: {
          // ownership: dayData.ownership, // REMOVED
          ratings: dayData.ratings, // â˜…NEWâ˜…
          headline: dayData.headline,
          memo1: dayData.memo1,
          memo2: dayData.memo2,
          memosExtra: dayData.memosExtra,
          timeline: dayData.timeline,
          focusSeconds: dayData.focusSeconds,
          focusLogs: dayData.focusLogs
        },
      };

      try {
        const { error } = await supabase
          .from('daily_logs') 
          .upsert([payload], { 
            onConflict: 'log_date' 
          });
        
        if (error) throw error;

        console.log(`Supabaseã¸ã® ${dateStr} ã®å˜æ—¥ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼`);
        return true;

      } catch (error) {
        console.error('å˜æ—¥ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error.message);
        return false;
      }
    }

    // =======================================================
    // ======== ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•° (5/10) - å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸç”¨ - ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° ========
    // =======================================================
    async function syncAllLocalDataToSupabase() {
        const syncBtn = document.getElementById('saveButton');
        if (syncBtn) syncBtn.disabled = true;

        console.log("å…¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã‚’é–‹å§‹ã—ã¾ã™...");
        
        const allPayloads = Object.keys(state.days)
            .filter(dateStr => dateStr) 
            .map(dateStr => {
                const dayData = withDefaults(state.days[dateStr], dateStr);
                return {
                    log_date: dayData.date, 
                    data: {
                        // ownership: dayData.ownership, // REMOVED
                        ratings: dayData.ratings, // â˜…NEWâ˜…
                        headline: dayData.headline,
                        memo1: dayData.memo1,
                        memo2: dayData.memo2,
                        memosExtra: dayData.memosExtra,
                        timeline: dayData.timeline,
                        focusSeconds: dayData.focusSeconds,
                        focusLogs: dayData.focusLogs
                    },
                };
            });

        if (allPayloads.length === 0) {
            alert("åŒæœŸã™ã‚‹è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            console.log("åŒæœŸã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚");
            if (syncBtn) syncBtn.disabled = false;
            return;
        }

        try {
            const { error } = await supabase
                .from('daily_logs')
                .upsert(allPayloads, { 
                    onConflict: 'log_date'
                });
            
            if (error) throw error;

            console.log(`Supabaseã¸ã®å…¨ãƒ‡ãƒ¼ã‚¿ (${allPayloads.length}æ—¥åˆ†) ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼`);
            alert(`âœ… å…¨${allPayloads.length}æ—¥åˆ†ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸã—ã¾ã—ãŸï¼`);

        } catch (error) {
            console.error('å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error.message);
            alert('å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');

        } finally {
            if (syncBtn) syncBtn.disabled = false;
        }
        return;
    }

    // =======================================================
    // ======== ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•° (6/10) - ã‚¯ãƒ©ã‚¦ãƒ‰å…¨å‰Šé™¤ - å¤‰æ›´ãªã— ========
    // =======================================================
    async function deleteAllCloudData() {
        console.log("Supabaseã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...");
        try {
            const { error } = await supabase
                .from('daily_logs')
                .delete()
                .neq('log_date', '1900-01-01');

            if (error) throw error;

            console.log('Supabaseã®å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸï¼');
            return true;

        } catch (error) {
            console.error('Supabaseã®å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error.message);
            alert('âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return false;
        }
    }
    // =======================================================

    function renderCalendar() {
      headerTitle.textContent = "Calendar";
      headerSub.textContent = "æœˆã¨æ—¥ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ç¢ºèª";
      headerScore.textContent = "";

      if (state.calendarMode === "month") {
        renderCalendarMonth();
      } else {
        renderCalendarDay();
      }
    }
    
    function renderCalendarMonth() {
      const monthDate = state.currentDate;
      const year = monthDate.getFullYear();
      const month = monthDate.getMonth();
      const monthLabel = `${year}å¹´ ${month + 1}æœˆ`;
      const days = getMonthDays(monthDate);
      const weekdayLabels = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      const todayStr = ymd(new Date());

      const daysHtml = days.map(d => {
        if (!d) return `<div class="day-cell empty"></div>`;
        const dateStr = ymd(d);
        const data = state.days[dateStr];
        
        // â˜…NEW: æ‰€æœ‰åº¦ã‹ã‚‰å¹³å‡è©•ä¾¡ç‚¹ã«å¤‰æ›´
        const avgRating = data && Array.isArray(data.ratings) 
            ? (data.ratings.reduce((a, b) => a + b, 0) / data.ratings.length).toFixed(1)
            : "";
        const ratingDisplay = avgRating ? `Avg: ${avgRating}` : "";
        const isToday = dateStr === todayStr ? "today-outline" : "";

        return `
          <div class="day-cell ${isToday}" data-date="${dateStr}">
            <div class="day-number">${d.getDate()}</div>
            <div class="day-ownership">${ratingDisplay}</div>
          </div>
        `;
      }).join("");

      mainEl.innerHTML = `
        <div class="card">
          <div class="view-toggle">
            <button class="${state.calendarMode === "month" ? "active" : ""}" data-view="month">Month</button>
            <button class="${state.calendarMode === "day" ? "active" : ""}" data-view="day">Day</button>
          </div>
          <div class="month-header">
            <button id="prev-month">â—€</button>
            <div class="month-header-title">${monthLabel}</div>
            <button id="next-month">â–¶</button>
          </div>
          <div class="weekday-row">
            ${weekdayLabels.map(w => `<div class="weekday">${w}</div>`).join("")}
          </div>
          <div class="calendar-grid">
            ${daysHtml}
          </div>
        </div>
      `;

      document.querySelectorAll(".view-toggle button").forEach(btn => {
        btn.addEventListener("click", () => {
          state.calendarMode = btn.dataset.view;
          render();
        });
      });

      document.getElementById("prev-month").onclick = () => {
        state.currentDate = new Date(year, month - 1, 1);
        render();
      };
      document.getElementById("next-month").onclick = () => {
        state.currentDate = new Date(year, month + 1, 1);
        render();
      };

      document.querySelectorAll(".day-cell[data-date]").forEach(cell => {
        cell.addEventListener("click", () => {
          const dateStr = cell.dataset.date;
          state.currentDate = stripTime(new Date(dateStr));
          state.calendarMode = "day";
          render();
        });
      });
    }

    // â˜…â˜…â˜… NEW: ã‚¿ã‚¤ãƒ ãƒ–ãƒ­ãƒƒã‚¯ç·¨é›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« â˜…â˜…â˜…
    function openTimeBlockSheet(dateStr, startIdx, endIdx) {
        const d = new Date(dateStr);
        const dayData = withDefaults(state.days[dateStr], dateStr); 
        const timeline = dayData.timeline;
        
        const startH = Math.floor(startIdx / 12);
        const startM = (startIdx % 12) * 5;
        const endH = Math.floor(endIdx / 12);
        const endM = (endIdx % 12) * 5;
        
        // Current category
        const currentCatId = timeline[startIdx];
        const durationBlocks = endIdx - startIdx;
        
        const overlay = document.createElement("div");
        overlay.className = "sheet-backdrop";
        overlay.innerHTML = `
            <div class="sheet" style="max-height: 70vh;">
                <div class="sheet-handle"></div>
                <div class="sheet-header">
                    <h3>${dateStr} ${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')}ã€œ</h3>
                    <button class="sheet-close">âœ•</button>
                </div>
                <div class="card" style="margin-bottom:10px;">
                    <div class="section-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†</div>
                    <p class="muted" style="font-size:11px;">
                        é–‹å§‹ ${String(startH).padStart(2, '0')}:${String(startM).padStart(2, '0')} ã‹ã‚‰ 
                        ${endIdx === 288 ? '24:00' : `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`} ã®é–“
                    </p>
                    <div class="field-label" style="margin-top:10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</div>
                    <select id="block-category-select" class="headline-input">
                        <option value="null">æœªè¨­å®šï¼ˆç©ºãæ™‚é–“ï¼‰</option>
                        ${state.categories.map(c => 
                            `<option value="${c.id}" ${c.id === currentCatId ? 'selected' : ''}>${c.name}</option>`
                        ).join('')}
                    </select>
                    
                    <div class="field-label" style="margin-top:10px;">é©ç”¨ç¯„å›²ï¼ˆåˆ†ï¼‰</div>
                    <p class="muted" style="font-size:11px; margin-bottom:5px;">
                        ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å…¨ä½“ã«é©ç”¨ã™ã‚‹å ´åˆã¯å¤‰æ›´ä¸è¦ã§ã™ã€‚ï¼ˆ${durationBlocks * 5}åˆ†ï¼‰
                    </p>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="number" id="duration-minutes-input" value="${durationBlocks * 5}" min="5" max="${durationBlocks * 5}" step="5" style="width: 80px; text-align:right;"> åˆ†
                    </div>
                </div>
                <div class="save-row">
                    <button class="btn btn-primary" id="save-block-btn">é©ç”¨ã—ã¦ä¿å­˜</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);

        const close = () => {
            document.body.removeChild(overlay);
        };

        overlay.querySelector(".sheet-close").onclick = close;
        overlay.addEventListener("click", (e) => {
            if (e.target === overlay) close();
        });

        overlay.querySelector("#save-block-btn").onclick = async () => {
            const newCatId = overlay.querySelector("#block-category-select").value === 'null' 
                            ? null 
                            : overlay.querySelector("#block-category-select").value;
            const durationMinutes = Number(overlay.querySelector("#duration-minutes-input").value);
            const blocksToApply = Math.floor(durationMinutes / 5);

            if (blocksToApply <= 0 || blocksToApply > durationBlocks) {
                alert('é©ç”¨ã™ã‚‹æ™‚é–“ã¯5åˆ†ä»¥ä¸Šã‹ã¤ç¾åœ¨ã®ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                return;
            }

            const actualEndIdx = startIdx + blocksToApply;

            // Apply new category to the selected range
            for (let i = startIdx; i < actualEndIdx; i++) {
                timeline[i] = newCatId;
            }
            // é©ç”¨ç¯„å›²å¤–ï¼ˆæ®‹ã‚Šã®éƒ¨åˆ†ï¼‰ã¯å…ƒã®ã‚«ãƒ†ã‚´ãƒªã§æ®‹ã™ã€‚å†æç”»ã§æ­£ã—ãå†ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚Œã‚‹ã€‚

            dayData.timeline = timeline;
            state.days[dateStr] = dayData;
            saveDays(state.days);
            
            await saveDailyData(dateStr); 

            close();
            renderCalendarDay();
        };
    }
    // â˜…â˜…â˜… END NEW â˜…â˜…â˜…

    function renderCalendarDay() {
      const d = state.currentDate;
      const dateStr = ymd(d);
      const data = withDefaults(state.days[dateStr], dateStr); 
      const dateLabel = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
      const todayStr = ymd(new Date());

      const timeline = Array.isArray(data.timeline) && data.timeline.length === 288 ? data.timeline : Array(288).fill(null);
      
      // --- NEW: å¯å‡¦åˆ†æ™‚é–“è¨ˆç®— ---
      const totalBlocks = 288;
      const scheduledBlocks = timeline.filter(catId => catId !== null).length;
      const unscheduledBlocks = totalBlocks - scheduledBlocks;
      const unscheduledMinutes = unscheduledBlocks * 5;
      const unscheduledHours = Math.floor(unscheduledMinutes / 60);
      const unscheduledMinsRemainder = unscheduledMinutes % 60;
      
      const unscheduledTimeStr = `${unscheduledHours}æ™‚é–“${unscheduledMinsRemainder}åˆ†`;
      // --- END NEW ---
      
      // --- ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆé€£çµï¼‰ãƒ­ã‚¸ãƒƒã‚¯ ---
      const groupedTimeline = [];
      let currentCatId = null;
      let startIdx = 0;

      for (let i = 0; i < timeline.length; i++) {
          const nextCatId = timeline[i];
          
          if (nextCatId !== currentCatId) {
              if (currentCatId !== null || i > 0) {
                  groupedTimeline.push({
                      catId: currentCatId,
                      startIdx: startIdx,
                      endIdx: i
                  });
              }
              currentCatId = nextCatId;
              startIdx = i;
          }
      }
      if (startIdx < timeline.length) {
          groupedTimeline.push({
              catId: currentCatId,
              startIdx: startIdx,
              endIdx: timeline.length 
          });
      }
      // --- END: ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆé€£çµï¼‰ãƒ­ã‚¸ãƒƒã‚¯ ---

      // â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚«ãƒ†ã‚´ãƒªé¸æŠã§ã¯ãªãã€ä¸€æ‹¬ç™»éŒ²ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦æ®‹ã™ â˜…â˜…â˜…
      const categoryChipsHtml = state.categories.map(cat => {
        const isActive = cat.id === state.activeCategoryId ? "active" : "";
        
        return `
          <button class="category-chip ${isActive}" data-id="${cat.id}">
            <span class="category-color-dot" style="background:${cat.color}"></span>
            ${cat.name}
          </button>
        `;
      }).join("");
      
      // --- NEW: Gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã®æ™‚é–“ãƒ©ãƒ™ãƒ« (24æ™‚é–“) ---
      const hourLabelsHtml = Array.from({length: 24}).map((_, hour) => {
          const hourLabel = String(hour).padStart(2,"0") + ":00";
          return `<div class="hour-label-block" style="grid-row: ${hour * 12 + 1} / span 12;">${hourLabel}</div>`;
      }).join("");

      // --- NEW: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã®HTML (é€£çµè¡¨ç¤º) ---
      const scheduleBlocksHtml = groupedTimeline.map(group => {
          const cat = group.catId ? getCategoryById(group.catId) : null;
          const bg = cat ? cat.color : "var(--card)"; 
          const name = cat ? cat.name : "æœªè¨­å®š";
          
          const durationMinutes = (group.endIdx - group.startIdx) * 5;

          const startH = String(Math.floor(group.startIdx / 12)).padStart(2, '0');
          const startM = String((group.startIdx % 12) * 5).padStart(2, '0');
          
          let endIdxForTime = group.endIdx;
          let endH, endM;

          if (endIdxForTime === 288) {
              endH = '24';
              endM = '00';
          } else {
              endH = String(Math.floor(endIdxForTime / 12)).padStart(2, '0');
              endM = String((endIdxForTime % 12) * 5).padStart(2, '0');
          }

          const gridRowStart = group.startIdx + 1;
          const gridRowEnd = group.endIdx + 1;

          return `
              <div class="schedule-block ${cat ? 'active' : 'empty'}" 
                   data-start="${group.startIdx}" 
                   data-end="${group.endIdx}" 
                   style="background:${bg}; grid-row: ${gridRowStart} / ${gridRowEnd};">
                  <div class="schedule-text">
                      <span style="font-weight:bold;">${name}</span>
                      <span class="schedule-time">${startH}:${startM} - ${endH}:${endM} (${durationMinutes}åˆ†)</span>
                  </div>
              </div>
          `;
      }).join("");


      const startOptions = Array.from({length: 24}).map((_,h)=>`<option value="${h}">${String(h).padStart(2,"0")}æ™‚</option>`).join("");
      const minsOptions = [0,5,10,15,20,25,30,35,40,45,50,55].map(m => `<option value="${m}">${String(m).padStart(2,"0")}åˆ†</option>`).join("");

      mainEl.innerHTML = `
        <div class="card">
          <div class="view-toggle">
            <button class="${state.calendarMode === "month" ? "active" : ""}" data-view="month">Month</button>
            <button class="${state.calendarMode === "day" ? "active" : ""}" data-view="day">Day</button>
          </div>
          <div class="day-timeline-header">
            <button class="day-nav-btn" id="prev-day">â—€</button>
            <h3>${dateLabel}</h3>
            <button class="day-nav-btn" id="next-day">â–¶</button>
          </div>
          <div class="category-chips">${categoryChipsHtml}</div>
          
          <div style="text-align:center; padding: 8px 0; border-bottom: 1px dashed var(--text-muted); margin-bottom:10px; border-radius: 4px;">
              <span class="muted" style="font-size:11px;">æœªè¨­å®šæ™‚é–“ï¼ˆå¯å‡¦åˆ†æ™‚é–“ï¼‰åˆè¨ˆ: </span>
              <span style="font-weight:bold; color:var(--accent);">${unscheduledTimeStr}</span>
          </div>
          
          <div class="section-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰</div>
          
          <div class="schedule-view-wrapper">
              <div class="hour-labels-col">
                  ${hourLabelsHtml}
              </div>
              <div class="schedule-timeline-col" id="schedule-timeline-col">
                  ${scheduleBlocksHtml}
              </div>
          </div>
          
          <div class="section-title" style="margin-top:10px;">æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ä¸€æ‹¬ç™»éŒ²</div>
          <div class="range-select-row">
            <span>ã‚«ãƒ†ã‚´ãƒª:</span>
            <select id="range-category-select" style="flex-grow:1; margin-right: 8px;">
                ${state.categories.map(c => `<option value="${c.id}" ${c.id === state.activeCategoryId ? 'selected' : ''}>${c.name}</option>`).join('')}
            </select>
          </div>
          <div class="range-select-row" style="margin-top: 5px;">
            <span>é–‹å§‹:</span>
            <select id="range-start-hour">${startOptions}</select>
            <select id="range-start-min">${minsOptions}</select>
            <span>ã€œ çµ‚äº†:</span>
            <select id="range-end-hour">${startOptions}</select>
            <select id="range-end-min">${minsOptions}</select>
            <button class="btn btn-primary" id="range-apply-btn" style="padding: 4px 8px;">é©ç”¨</button>
          </div>
        </div>
        <div class="card">
          <button class="btn btn-primary" style="width:100%;" id="open-sheet-btn">
            è¨˜éŒ²ï¼ˆæŒ¯ã‚Šè¿”ã‚Šã€ãƒ¡ãƒ¢ï¼‰ã‚’è¦‹ã‚‹ãƒ»ç·¨é›†ã™ã‚‹
          </button>
        </div>
      `;
      document.querySelectorAll(".view-toggle button").forEach(btn => {
        btn.addEventListener("click", () => {
          state.calendarMode = btn.dataset.view;
          render();
        });
      });
      document.getElementById("prev-day").onclick = () => {
        state.currentDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() - 1);
        render();
      };
      document.getElementById("next-day").onclick = () => {
        state.currentDate = new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1);
        render();
      };
      document.getElementById("open-sheet-btn").onclick = () => openDaySheet(dateStr);

      // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (ActiveCategoryã®åˆ‡ã‚Šæ›¿ãˆ)
      document.querySelectorAll(".category-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const id = chip.dataset.id;
          state.activeCategoryId = id;
          document.getElementById("range-category-select").value = id; // ä¸€æ‹¬ç™»éŒ²ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
          renderCalendarDay(); 
        });
      });

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆé€£çµãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ -> ã‚·ãƒ¼ãƒˆã‚’é–‹ã
      document.querySelectorAll(".schedule-block").forEach(block => {
        block.addEventListener("click", (e) => {
            const startIdx = Number(block.dataset.start);
            const endIdx = Number(block.dataset.end);
            openTimeBlockSheet(dateStr, startIdx, endIdx); // â˜…NEW: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ã
        });
      });

      const startHourSel = document.getElementById("range-start-hour");
      const startMinSel = document.getElementById("range-start-min");
      const endHourSel = document.getElementById("range-end-hour");
      const endMinSel = document.getElementById("range-end-min");
      const categorySel = document.getElementById("range-category-select"); // NEW
      const applyBtn = document.getElementById("range-apply-btn");

      // ActiveCategoryã®åˆæœŸå€¤è¨­å®š
      if(state.activeCategoryId) categorySel.value = state.activeCategoryId;
      
      // ä¸€æ‹¬ç™»éŒ²ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã® activeCategoryId ã®æ›´æ–°
      categorySel.onchange = (e) => {
          state.activeCategoryId = e.target.value;
          document.querySelectorAll(".category-chip").forEach(chip => {
             chip.classList.toggle("active", chip.dataset.id === state.activeCategoryId);
          });
      };

      applyBtn.onclick = async () => {
        const startH = Number(startHourSel.value);
        const startM = Number(startMinSel.value);
        const endH = Number(endHourSel.value);
        const endM = Number(endMinSel.value);
        const targetCatId = categorySel.value;

        const startIdx = hmToIndex(startH, startM);
        const endIdx = hmToIndex(endH, endM);

        if (!targetCatId) {
          alert("ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        let start = startIdx;
        let end = endIdx;
        if (start > end) { 
          end += 288;
        }

        for (let i = start; i < end; i++) {
          const idx = i % 288;
          timeline[idx] = targetCatId;
        }

        data.timeline = timeline;
        state.days[dateStr] = data;
        saveDays(state.days);
        
        await saveDailyData(dateStr);
        renderCalendarDay();
      };
    }
    
    function openDaySheet(dateStr) {
      const d = new Date(dateStr);
      const dateLabel = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
      let dayData = withDefaults(state.days[dateStr], dateStr);
      
      // â˜…NEW: æŒ¯ã‚Šè¿”ã‚Šè©•ä¾¡ã®HTMLç”Ÿæˆ
      const ratingsHtml = state.reviewCriteria.map((crit, index) => {
          const currentRating = dayData.ratings[index] || 3;
          return `
              <div style="margin-bottom: 12px;">
                  <div class="field-label">${crit.name} (1:æœ€æ‚ª - 5:æœ€é«˜)</div>
                  <div class="rating-row">
                      <input type="range" min="1" max="5" value="${currentRating}" id="rating-range-${index}" data-index="${index}" class="rating-range-input">
                      <span id="rating-label-${index}" class="rating-label">${currentRating}</span>
                  </div>
              </div>
          `;
      }).join('');
      // â˜…END NEWâ˜…

      const overlay = document.createElement("div");
      overlay.className = "sheet-backdrop";
      overlay.innerHTML = `
        <div class="sheet">
          <div class="sheet-handle"></div>
          <div class="sheet-header">
            <h3>${dateLabel}</h3>
            <button class="sheet-close">âœ•</button>
          </div>
          <div class="card" style="margin-bottom:10px;">
            <div class="section-title">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šï¼ˆ5æ®µéšè©•ä¾¡ï¼‰</div>
            ${ratingsHtml} </div>
          <div class="card" style="margin-bottom:10px;">
            <div class="field-label">ä»Šæ—¥ã®ä¸€è¨€</div>
            <input type="text" class="headline-input" id="headline-input" placeholder="ä¾‹ï¼šã‚¹ãƒãƒ›ã‚ˆã‚Šç°¿è¨˜ã‚’å„ªå…ˆã§ããŸ" value="${(dayData.headline || "").replace(/"/g, "&quot;")}">
            <div class="field-label">ãƒ¡ãƒ¢1ï¼ˆå®¢è¦³ãƒ­ã‚°ï¼‰</div>
            <textarea class="memo-input" id="memo1-input" placeholder="ä½•æ™‚ã«ä½•ã‚’ã—ãŸã‹ã€ã–ã£ãã‚Šã§OK">${dayData.memo1 || ""}</textarea>
            <div class="field-label">ãƒ¡ãƒ¢2ï¼ˆä¸»è¦³ï¼šæ°—ã¥ããƒ»åçœï¼‰</div>
            <textarea class="memo-input" id="memo2-input" placeholder="ã©ã†æ„Ÿã˜ãŸã‹ã€ã©ã“ãŒè‰¯ãã¦ã©ã“ãŒå¾®å¦™ã ã£ãŸã‹">${dayData.memo2 || ""}</textarea>
            <div class="field-label">è¿½åŠ ãƒ¡ãƒ¢ï¼ˆå¿…è¦ãªã‚‰ã„ãã¤ã§ã‚‚ï¼‰</div>
            <div id="extra-memos"></div>
            <button class="btn btn-ghost" id="add-memo-btn" style="margin-top:6px;">ï¼‹ ãƒ¡ãƒ¢æ ã‚’è¿½åŠ </button>
          </div>
          <div class="save-row">
            <button class="btn btn-ghost" id="delete-day-btn">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
            <button class="btn btn-primary" id="save-day-btn">ä¿å­˜</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      const close = () => {
        document.body.removeChild(overlay);
        if (state.calendarMode === 'month') renderCalendarMonth();
        if (state.calendarMode === 'day') renderCalendarDay(); // Dayãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å†æç”»
        if (state.currentTab === 'today') renderToday(); // Todayãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å†æç”»
      };
      
      overlay.querySelector(".sheet-close").onclick = close;
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) close();
      });

      // â˜…NEW: è©•ä¾¡ãƒ¬ãƒ³ã‚¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      overlay.querySelectorAll(".rating-range-input").forEach(rangeEl => {
          const index = Number(rangeEl.dataset.index);
          const labelEl = overlay.querySelector(`#rating-label-${index}`);
          rangeEl.addEventListener("input", (e) => {
              labelEl.textContent = e.target.value;
              dayData.ratings[index] = Number(e.target.value); // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          });
      });
      // â˜…END NEWâ˜…

      // Extra memo logic
      const extraContainer = overlay.querySelector("#extra-memos");
      const renderExtraMemos = () => {
        extraContainer.innerHTML = (dayData.memosExtra || []).map((memo, index) => `
          <div style="display:flex; gap:4px; align-items:flex-start; margin-bottom:4px;">
            <textarea class="memo-input" data-index="${index}" placeholder="è¿½åŠ ãƒ¡ãƒ¢">${memo}</textarea>
            <button class="btn btn-ghost delete-memo-btn" data-index="${index}" style="padding:4px 6px; flex-shrink:0;">å‰Šé™¤</button>
          </div>
        `).join("");

        overlay.querySelectorAll(".memo-input[data-index]").forEach(input => {
          input.addEventListener("input", (e) => {
            const index = Number(e.target.dataset.index);
            dayData.memosExtra[index] = e.target.value;
          });
        });

        overlay.querySelectorAll(".delete-memo-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const index = Number(e.target.dataset.index);
            dayData.memosExtra.splice(index, 1);
            renderExtraMemos();
          });
        });
      };

      renderExtraMemos();
      overlay.querySelector("#add-memo-btn").onclick = () => {
        if (!dayData.memosExtra) dayData.memosExtra = [];
        dayData.memosExtra.push("");
        renderExtraMemos();
      };

      // Save logic
      overlay.querySelector("#save-day-btn").onclick = async () => {
        // dayData.ownership ã®æ›´æ–°ã¯ãªããªã£ãŸã€‚ratings ã¯ãƒ¬ãƒ³ã‚¸ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã§æ›´æ–°æ¸ˆã¿
        dayData.headline = overlay.querySelector("#headline-input").value.trim();
        dayData.memo1 = overlay.querySelector("#memo1-input").value.trim();
        dayData.memo2 = overlay.querySelector("#memo2-input").value.trim();

        state.days[dateStr] = dayData;
        saveDays(state.days);
        
        // Supabaseã¸ä¿å­˜ (å˜æ—¥)
        const success = await saveDailyData(dateStr); 
        if (success) {
            alert('ã“ã®æ—¥ã®è¨˜éŒ²ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        close();
      };

      // Delete logic
      overlay.querySelector("#delete-day-btn").onclick = () => {
        if (confirm(`${dateLabel}ã®è¨˜éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
          delete state.days[dateStr];
          saveDays(state.days);
          close();
        }
      };
    }

    function formatMMSS(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      return `${m}:${s}`;
    }
    
    function renderToday() {
      headerTitle.textContent = "Today";
      headerSub.textContent = "ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹";
      const today = stripTime(new Date());
      const todayStr = ymd(today);
      const dayData = withDefaults(state.days[todayStr], todayStr);
      
      // â˜…NEW: å¹³å‡è©•ä¾¡ç‚¹
      const avgRating = Array.isArray(dayData.ratings) ? (dayData.ratings.reduce((a, b) => a + b, 0) / dayData.ratings.length).toFixed(1) : "--";
      headerScore.textContent = avgRating;

      const focusSeconds = dayData.focusSeconds || 0;
      const runningLabel = focusTimer.running ? "é›†ä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­â€¦" : "åœæ­¢ä¸­";

      // â˜…NEW: ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®HTML
      const categorySelectHtml = state.categories.map(c => 
          `<option value="${c.id}">${c.name}</option>`
      ).join('');

      mainEl.innerHTML = `
        <div class="card">
          <div class="ownership-row">
            <div>
              <div class="muted">${todayStr}</div>
              <div class="ownership-main">${avgRating} / 5</div>
            </div>
            <div>
              <div class="muted">ç›®æ¨™: 4.0</div>
              <div class="tagline">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šå¹³å‡ç‚¹</div>
              <button class="pill" id="open-sheet-btn">
                <span>ğŸ“ è¨˜éŒ²ã‚’ç·¨é›†</span>
              </button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="section-title">ä»Šæ—¥ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‰</div>
          <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="flex-grow:1;">
              <div class="timer-display" id="session-display">${formatMMSS(focusTimer.sessionSeconds)}</div>
              <div class="muted" id="timer-status" style="font-size:10px;">${runningLabel}</div>
            </div>
            <div>
              <div class="timer-display">${formatMMSS(focusSeconds)}</div>
              <div class="muted" style="font-size:10px;text-align:right;">ç´¯è¨ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚é–“</div>
            </div>
          </div>
          <div class="timer-buttons">
            <button class="btn ${focusTimer.running ? 'btn-ghost' : 'btn-primary'}" id="timer-start-btn">
              <span style="font-size:16px;">${focusTimer.running ? 'â¸' : 'â–¶'}</span>
              ${focusTimer.running ? 'ä¸€æ™‚åœæ­¢' : 'é–‹å§‹'}
            </button>
            <button class="btn btn-primary" id="timer-add-btn" ${focusTimer.sessionSeconds === 0 ? 'disabled style="opacity:0.5;cursor:default;"' : ''}>
              <span style="font-size:16px;">â•</span>
              è¨˜éŒ²ã«è¿½åŠ 
            </button>
            <button class="btn btn-ghost" id="timer-reset-session-btn">
              ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
          <div class="pomodoro-row">
            <span class="muted" style="font-size:11px;">é›†ä¸­æ™‚é–“:</span>
            <input type="number" id="focus-input" value="${state.pomodoroFocus}" min="1" max="60">
            <span class="muted" style="font-size:11px;">åˆ† / ä¼‘æ†©:</span>
            <input type="number" id="break-input" value="${state.pomodoroBreak}" min="1" max="30">
            <span class="muted" style="font-size:11px;">åˆ†</span>
          </div>
          <input type="text" class="focus-label-input" id="focus-label" placeholder="ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å†…å®¹ï¼ˆä¾‹ï¼šç°¿è¨˜ã®å‹‰å¼·ï¼‰">
          <select id="focus-category-select" style="margin-top: 8px; padding: 8px; border-radius: 6px; border: 1px solid var(--text-muted); background: var(--card); color: var(--text-main);">
              <option value="">è¨˜éŒ²å…ˆã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>
              ${categorySelectHtml}
          </select>
          </div>
        
        <div class="card">
          <div class="section-title">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å±¥æ­´</div>
          <div id="focus-logs">
            ${(dayData.focusLogs || []).reverse().map(log => `
              <div class="muted" style="font-size:11px; margin-top:4px;">
                ${new Date(log.at).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})} 
                - ${formatMMSS(log.sec)}
                ${log.label ? ` (${log.label})` : ''}
                ${log.categoryId ? ` [${getCategoryById(log.categoryId)?.name || 'ä¸æ˜'}]` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.getElementById("open-sheet-btn").onclick = () => openDaySheet(todayStr);

      const displayEl = () => document.getElementById("session-display");

      function tickTimer() {
        if (!focusTimer.running || !focusTimer.startTs) return;
        const now = Date.now();
        const diffSec = Math.floor((now - focusTimer.startTs) / 1000);
        focusTimer.sessionSeconds = diffSec;
        const el = displayEl();
        if (el) el.textContent = formatMMSS(diffSec);
      }
      
      if (timerIntervalId) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      if (focusTimer.running) {
        timerIntervalId = setInterval(tickTimer, 1000);
      } else {
        const el = displayEl();
        if (el) el.textContent = formatMMSS(focusTimer.sessionSeconds);
      }

      document.getElementById("timer-start-btn").onclick = () => {
        if (!focusTimer.running) {
          focusTimer.running = true;
          focusTimer.startTs = Date.now();
          focusTimer.sessionSeconds = 0;
          timerIntervalId = setInterval(tickTimer, 1000);
          render();
        } else {
          focusTimer.running = false;
          if (timerIntervalId) {
            clearInterval(timerIntervalId);
            timerIntervalId = null;
          }
          const now = Date.now();
          focusTimer.sessionSeconds = Math.floor((now - focusTimer.startTs) / 1000);
          focusTimer.startTs = null;
          render();
        }
      };

      document.getElementById("timer-add-btn").onclick = async () => {
        if (focusTimer.sessionSeconds <= 0) return;

        const labelInput = document.getElementById("focus-label");
        const label = labelInput ? labelInput.value.trim() : "";
        const categorySelect = document.getElementById("focus-category-select"); 
        const categoryId = categorySelect.value;
        
        if (!categoryId) {
            alert("ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚é–“ã®è¨˜éŒ²å…ˆã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const d = withDefaults(state.days[todayStr], todayStr);
        const addSec = focusTimer.sessionSeconds;
        
        // --- NEW: Rounding and Timeline update ---
        const totalMinutes = Math.round(addSec / 60); 
        const blocksToAdd = Math.round(totalMinutes / 5); 
        
        if (blocksToAdd > 0) {
            let blocksPlaced = 0;
            const timeline = d.timeline;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç©ºã„ã¦ã„ã‚‹æ ã«å‰ã‹ã‚‰é †ã«åŸ‹ã‚è¾¼ã‚€
            for (let i = 0; i < timeline.length; i++) {
                if (timeline[i] === null) {
                    timeline[i] = categoryId;
                    blocksPlaced++;
                }
                if (blocksPlaced >= blocksToAdd) break;
            }

            d.timeline = timeline;
            
            if (blocksPlaced < blocksToAdd) {
                console.warn(`Warning: Could only place ${blocksPlaced} out of ${blocksToAdd} blocks. Schedule might be full.`);
            }
        }
        // --- END NEW ---

        d.focusSeconds = (d.focusSeconds || 0) + addSec;
        if (!Array.isArray(d.focusLogs)) d.focusLogs = [];
        d.focusLogs.push({ sec: addSec, label, at: new Date().toISOString(), categoryId: categoryId }); 
        
        state.days[todayStr] = d;
        saveDays(state.days);
        
        await saveDailyData(todayStr); 

        focusTimer.sessionSeconds = 0;
        const el = displayEl();
        if (el) el.textContent = formatMMSS(0);
        render();
      };
      
      document.getElementById("timer-reset-session-btn").onclick = () => {
        focusTimer.sessionSeconds = 0;
        focusTimer.running = false;
        focusTimer.startTs = null;
        if (timerIntervalId) {
          clearInterval(timerIntervalId);
          timerIntervalId = null;
        }
        render();
      };

      document.getElementById("focus-input").onchange = (e) => {
        state.pomodoroFocus = Number(e.target.value);
      };
      document.getElementById("break-input").onchange = (e) => {
        state.pomodoroBreak = Number(e.target.value);
      };
    }

    function renderStats() {
      headerTitle.textContent = "Stats";
      headerSub.textContent = "æŒ¯ã‚Šè¿”ã‚Šå¹³å‡ç‚¹ã®æ¨ç§»";
      headerScore.textContent = "";

      const allDays = Object.keys(state.days)
          .filter(dateStr => dateStr)
          .sort()
          .map(dateStr => withDefaults(state.days[dateStr], dateStr));

      const NUM_DAYS = 30;
      const today = stripTime(new Date());
      const allDates = [];
      for (let i = 0; i < NUM_DAYS; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        allDates.unshift(d);
      }

      const page = state.statsPage;
      const startIndex = allDates.length - (page + 1) * 7;
      const endIndex = allDates.length - page * 7;
      
      const datesToDisplay = allDates.slice(Math.max(0, startIndex), endIndex);
      
      if (datesToDisplay.length === 0 && page > 0) {
          state.statsPage = 0; 
          renderStats();
          return;
      }
      
      const daysDataMap = new Map(allDays.map(d => [d.date, d]));
      const bars = datesToDisplay.map(d => {
        const dateStr = ymd(d);
        const data = daysDataMap.get(dateStr);
        
        // â˜…NEW: å¹³å‡è©•ä¾¡ç‚¹ã‚’è¨ˆç®—
        const avgRating = data && Array.isArray(data.ratings) 
            ? (data.ratings.reduce((a, b) => a + b, 0) / data.ratings.length)
            : 0;
        
        return { date: dateStr, rating: avgRating };
      });
      
      if (bars.length === 0) {
        mainEl.innerHTML = `<p class="center-note">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Todayã‚¿ãƒ–ã§è¨˜éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>`;
        return;
      }
      
      const oldestDate = datesToDisplay[0];
      const newestDate = datesToDisplay[datesToDisplay.length - 1];
      const rangeLabel = `${oldestDate.getMonth()+1}/${String(oldestDate.getDate()).padStart(2,"0")} ã€œ ${newestDate.getMonth()+1}/${String(newestDate.getDate()).padStart(2,"0")}`;

      mainEl.innerHTML = `
        <div class="card">
          <div class="stats-header">
            <button class="stats-nav-btn" id="stats-prev">â—€</button>
            <div class="section-title">ç›´è¿‘ã®æŒ¯ã‚Šè¿”ã‚Šå¹³å‡ç‚¹ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰</div>
            <button class="stats-nav-btn" id="stats-next"${page === 0 ? " disabled style='opacity:0.3;cursor:default;'" : ""}>â–¶</button>
          </div>
          <div class="muted" style="font-size:10px;margin-bottom:4px;">${rangeLabel}ï¼ˆå³ç«¯ãŒæœ€æ–°ï¼‰</div>
          <div class="bar-chart">
            ${bars.map(b => {
              const rating = b.rating || 0;
              const heightPx = 4 + (rating / 5) * 40; 
              const label = b.date.slice(5).replace("-", "/");
              return `
                <div class="bar-item">
                  <div class="bar" style="height:${heightPx}px;"></div>
                  <div class="bar-percent">${rating.toFixed(1)}</div>
                  <div class="bar-label">${label}</div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
        <p class="center-note">
          æ£’ãŒé«˜ã„æ—¥ã»ã©æŒ¯ã‚Šè¿”ã‚Šå¹³å‡ç‚¹ãŒé«˜ã„æ—¥ã€‚ï¼ˆæœªè¨˜éŒ²ã®æ—¥ã¯0ç‚¹ï¼‰
        </p>
      `;

      document.getElementById("stats-prev").onclick = () => {
        state.statsPage += 1;
        render();
      };
      document.getElementById("stats-next").onclick = () => {
        if (state.statsPage > 0) {
          state.statsPage -= 1;
          render();
        }
      };
    }

    function renderLogs() {
      headerTitle.textContent = "Logs";
      headerSub.textContent = "ã™ã¹ã¦ã®è¨˜éŒ²ã‹ã‚‰æ¤œç´¢";
      headerScore.textContent = "";

      const allLogs = Object.keys(state.days)
          .filter(dateStr => state.days[dateStr] && (state.days[dateStr].headline || state.days[dateStr].memo1 || state.days[dateStr].memo2 || (state.days[dateStr].memosExtra || []).length > 0))
          .sort((a, b) => b.localeCompare(a)) 
          .map(dateStr => withDefaults(state.days[dateStr], dateStr));

      mainEl.innerHTML = `
        <div class="card">
          <input type="text" class="headline-input" id="log-search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
        </div>
        <div id="log-results">
          ${allLogs.map(data => `
            <div class="card log-card" data-date="${data.date}">
              <h2>${data.date.replace(/-/g, '/')} ${data.headline ? `- ${data.headline}` : ''}</h2>
              <div class="muted" style="font-size:11px;">${data.memo1 || ''}</div>
            </div>
          `).join('')}
        </div>
        ${allLogs.length === 0 ? `<p class="center-note">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>` : ''}
      `;

      const searchInput = document.getElementById("log-search-input");
      const resultsContainer = document.getElementById("log-results");

      const filterLogs = () => {
        const query = searchInput.value.toLowerCase();
        const filtered = allLogs.filter(data => {
          return data.headline.toLowerCase().includes(query) ||
                 data.memo1.toLowerCase().includes(query) ||
                 data.memo2.toLowerCase().includes(query) ||
                 (data.memosExtra || []).some(m => m.toLowerCase().includes(query));
        });

        resultsContainer.innerHTML = filtered.map(data => `
          <div class="card log-card" data-date="${data.date}">
            <h2>${data.date.replace(/-/g, '/')} ${data.headline ? `- ${data.headline}` : ''}</h2>
            <div class="muted" style="font-size:11px;">${data.memo1 || ''}</div>
          </div>
        `).join('');

        document.querySelectorAll(".log-card").forEach(card => {
          card.addEventListener("click", () => {
            openDaySheet(card.dataset.date);
          });
        });
      };

      searchInput.addEventListener("input", filterLogs);
      filterLogs(); 
    }

    function renderRecurringLogsList() {
      const weekdayNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      const startOptions = Array.from({length:24}).map((_,h)=>`<option value="${h}">${String(h).padStart(2,"0")}æ™‚</option>`).join("");
      const minsOptions = [0,5,10,15,20,25,30,35,40,45,50,55].map(m => `<option value="${m}">${String(m).padStart(2,"0")}åˆ†</option>`).join("");

      return state.recurringLogs.map((log, index) => {
        const cat = getCategoryById(log.catId);
        
        const startH = Math.floor(log.startIdx / 12);
        const startM = (log.startIdx % 12) * 5;
        const endH = Math.floor(log.endIdx / 12);
        const endM = (log.endIdx % 12) * 5;

        return `
          <div class="recurring-log-item" style="border-left: 4px solid ${cat ? cat.color : 'var(--text-muted)'}; padding-left:8px; margin-bottom:12px;">
            <div style="font-size:12px; font-weight:bold; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
              <span>${cat ? cat.name : 'ä¸æ˜ãªã‚«ãƒ†ã‚´ãƒª'}</span>
              <button class="btn btn-ghost delete-recurring-btn" data-index="${index}" style="padding: 2px 6px;">å‰Šé™¤</button>
            </div>
            
            <div style="font-size:11px; margin-bottom:6px;">
              ${weekdayNames.map((name, i) => `
                <span style="padding: 2px 4px; border: 1px solid ${log.days.includes(i) ? cat.color : 'var(--text-muted)'}; background: ${log.days.includes(i) ? cat.color + '30' : 'transparent'}; border-radius:3px; margin-right:2px; cursor:pointer;" class="recurring-day-toggle" data-index="${index}" data-day="${i}">${name}</span>
              `).join('')}
            </div>

            <div style="display:flex; gap:4px; font-size:11px; align-items:center;">
              <select class="recurring-cat-select" data-index="${index}" style="width:100%;">
                ${state.categories.map(c => `<option value="${c.id}" ${c.id === log.catId ? 'selected' : ''}>${c.name}</option>`).join('')}
              </select>
            </div>
            
            <div style="display:flex; gap:4px; font-size:11px; align-items:center; margin-top:6px;">
              <span>é–‹å§‹:</span>
              <select class="recurring-start-h" data-index="${index}" data-type="h" data-default="${startH}">
                ${startOptions}
              </select>
              <select class="recurring-start-m" data-index="${index}" data-type="m" data-default="${startM}">
                ${minsOptions}
              </select>
              <span>ã€œ çµ‚äº†:</span>
              <select class="recurring-end-h" data-index="${index}" data-type="h" data-default="${endH}">
                ${startOptions}
              </select>
              <select class="recurring-end-m" data-index="${index}" data-type="m" data-default="${endM}">
                ${minsOptions}
              </select>
            </div>
          </div>
        `;
      }).join('');
    }


    function renderSettings() {
      headerTitle.textContent = "Settings";
      headerSub.textContent = "è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†";
      headerScore.textContent = "";

      mainEl.innerHTML = `
        <div class="card">
          
          <div class="section-title">ã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®š</div>
          <div id="category-settings">
            ${state.categories.map(cat => `
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--card);">
                <input type="color" class="cat-color-input" data-id="${cat.id}" value="${cat.color}" style="width:30px; height:30px; border:none; padding:0;">
                <input type="text" class="log-headline-input cat-name-input" data-id="${cat.id}" value="${cat.name}" style="flex-grow:1;">
                <div style="display:flex; flex-direction:column; gap:4px; margin-left:4px;">
                  <button class="btn btn-ghost cat-move-up-btn" data-id="${cat.id}" style="padding:2px 6px; font-size:10px;">â†‘</button>
                  <button class="btn btn-ghost cat-move-down-btn" data-id="${cat.id}" style="padding:2px 6px; font-size:10px;">â†“</button>
                </div>
                <button class="btn btn-ghost delete-cat-btn" data-id="${cat.id}" style="padding:4px 8px; margin-left:4px;">å‰Šé™¤</button>
              </div>
            `).join('')}
          </div>
          <button class="btn btn-ghost" id="add-cat-btn" style="margin-top:8px;">ï¼‹ æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ </button>
        </div>
        
        <div class="card" style="margin-top:10px;">

          <div class="section-title">æŒ¯ã‚Šè¿”ã‚ŠåŸºæº–ï¼ˆ3ã¤ã®è¦³ç‚¹ï¼‰</div>
          <p class="muted" style="font-size:11px; margin-bottom:10px;">
              1æ—¥ã‚’5æ®µéšè©•ä¾¡ã™ã‚‹éš›ã®3ã¤ã®è¦³ç‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚
          </p>
          <div id="review-criteria-settings">
              ${state.reviewCriteria.map((crit, index) => `
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                      <span style="font-weight:bold; width: 50px; flex-shrink: 0; font-size:12px;">è¦³ç‚¹ ${index + 1}</span>
                      <input type="text" class="log-headline-input criteria-name-input" data-index="${index}" value="${crit.name}" style="flex-grow:1;">
                  </div>
              `).join('')}
          </div>
        </div>
        <div class="card">
          <div class="section-title">ç¹°ã‚Šè¿”ã—ãƒ­ã‚°ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šï¼‰</div>
          <p class="muted" style="font-size:11px; margin-bottom:10px;">
            è¨­å®šã—ãŸæ›œæ—¥ã¨æ™‚é–“å¸¯ã‚’ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç©ºã„ã¦ã„ã‚‹æ ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚ï¼ˆä¾‹: å¹³æ—¥9æ™‚ã€œ17æ™‚ã¯ã€Œå­¦æ ¡ã€ï¼‰
          </p>
          <div id="recurring-logs-settings">
            ${renderRecurringLogsList()}
          </div>
          <button class="btn btn-ghost" id="add-recurring-btn" style="margin-top:8px;">ï¼‹ ç¹°ã‚Šè¿”ã—ãƒ­ã‚°ã‚’è¿½åŠ </button>
        </div>

        <div class="card">
          <div class="section-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
          <p class="muted" style="font-size:11px; margin-bottom:8px;">
            ã“ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆSupabaseï¼‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
          </p>
          <button class="btn btn-ghost" id="export-btn" style="margin-right:8px;">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-ghost" id="clear-btn" style="color:var(--danger); border-color:var(--danger);">å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
        </div>
      `;

      // --- ã‚«ãƒ†ã‚´ãƒªè¨­å®šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
      document.querySelectorAll(".cat-name-input").forEach(input => {
        input.addEventListener("input", (e) => {
          const id = e.target.dataset.id;
          const cat = getCategoryById(id);
          if (cat) cat.name = e.target.value;
          saveCategories(state.categories);
        });
      });
      document.querySelectorAll(".cat-color-input").forEach(input => {
        input.addEventListener("input", (e) => {
          const id = e.target.dataset.id;
          const cat = getCategoryById(id);
          if (cat) cat.color = e.target.value;
          saveCategories(state.categories);
        });
      });
      
      document.querySelectorAll(".delete-cat-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.dataset.id;
          if (state.categories.length <= 1) {
            alert("ã‚«ãƒ†ã‚´ãƒªã¯æœ€ä½1ã¤å¿…è¦ã§ã™ã€‚");
            return;
          }
          if (!confirm(`ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Œ${getCategoryById(id).name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§è¨˜éŒ²ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ï¼‰`)) return;

          state.categories = state.categories.filter(c => c.id !== id);
          if (state.activeCategoryId === id) state.activeCategoryId = state.categories[0].id;
          saveCategories(state.categories);
          renderSettings();
        });
      // ä¸¦ã³é †ã‚’ä¸Šä¸‹ã«å…¥ã‚Œæ›¿ãˆã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
      function moveCategory(id, direction) {
        const idx = state.categories.findIndex(c => c.id === id);
        if (idx === -1) return;
        const target = direction === "up" ? idx - 1 : idx + 1;
        if (target < 0 || target >= state.categories.length) return;
        const tmp = state.categories[idx];
        state.categories[idx] = state.categories[target];
        state.categories[target] = tmp;
        // ä¸¦ã³é †å¤‰æ›´ã‚’ä¿å­˜ã—ã¦å†æç”»
        saveCategories(state.categories);
        renderSettings();
      }

      document.querySelectorAll(".cat-move-up-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.dataset.id;
          moveCategory(id, "up");
        });
      });

      document.querySelectorAll(".cat-move-down-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.dataset.id;
          moveCategory(id, "down");
        });
      });

      });

      document.getElementById("add-cat-btn").onclick = () => {
        const newId = "cat_" + Date.now();
        state.categories.push({
          id: newId,
          name: "æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒª",
          color: "#facc15",
        });
        saveCategories(state.categories);
        if (!state.activeCategoryId) state.activeCategoryId = newId;
        renderSettings();
      };
      
      // â˜…NEW: æŒ¯ã‚Šè¿”ã‚ŠåŸºæº–è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.querySelectorAll(".criteria-name-input").forEach(input => {
          input.addEventListener("input", (e) => {
              const index = Number(e.target.dataset.index);
              state.reviewCriteria[index].name = e.target.value;
              saveReviewCriteria(state.reviewCriteria);
          });
      });
      // â˜…END NEWâ˜…

      // --- ç¹°ã‚Šè¿”ã—ãƒ­ã‚°è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
      const recurringContainer = document.getElementById("recurring-logs-settings");

      function updateRecurringLog(index) {
          const item = state.recurringLogs[index];
          if (!item) return;

          const startH = Number(recurringContainer.querySelector(`.recurring-start-h[data-index="${index}"]`).value);
          const startM = Number(recurringContainer.querySelector(`.recurring-start-m[data-index="${index}"]`).value);
          const endH = Number(recurringContainer.querySelector(`.recurring-end-h[data-index="${index}"]`).value);
          const endM = Number(recurringContainer.querySelector(`.recurring-end-m[data-index="${index}"]`).value);

          let startIdx = hmToIndex(startH, startM);
          let endIdx = hmToIndex(endH, endM);

          if (endH === 0 && endM === 0) {
              endIdx = 288;
          } else if (startIdx >= endIdx) {
              [startIdx, endIdx] = [endIdx, startIdx];
          }

          item.startIdx = startIdx;
          item.endIdx = endIdx;
          
          const catSelect = recurringContainer.querySelector(`.recurring-cat-select[data-index="${index}"]`);
          item.catId = catSelect.value;
          
          saveRecurringLogs(state.recurringLogs);
          renderSettings(); 
      }

      recurringContainer.addEventListener('change', (e) => {
          if (e.target.matches('.recurring-cat-select, .recurring-start-h, .recurring-start-m, .recurring-end-h, .recurring-end-m')) {
              const index = Number(e.target.dataset.index);
              updateRecurringLog(index);
          }
      });

      recurringContainer.addEventListener('click', (e) => {
          if (e.target.matches('.recurring-day-toggle')) {
              const index = Number(e.target.dataset.index);
              const day = Number(e.target.dataset.day);
              const log = state.recurringLogs[index];
              if (!log) return;

              const dayIndex = log.days.indexOf(day);
              if (dayIndex > -1) {
                  log.days.splice(dayIndex, 1); 
              } else {
                  log.days.push(day); 
                  log.days.sort((a,b) => a-b);
              }
              saveRecurringLogs(state.recurringLogs);
              renderSettings(); 
          }
          if (e.target.matches('.delete-recurring-btn')) {
              const index = Number(e.target.dataset.index);
              state.recurringLogs.splice(index, 1);
              saveRecurringLogs(state.recurringLogs);
              renderSettings();
          }
      });

      document.getElementById("add-recurring-btn").onclick = () => {
          state.recurringLogs.push({
              catId: state.categories[0] ? state.categories[0].id : 'other',
              days: [1, 2, 3, 4, 5], 
              startIdx: hmToIndex(9, 0), 
              endIdx: hmToIndex(17, 0) 
          });
          saveRecurringLogs(state.recurringLogs);
          renderSettings();
      };
      
      document.querySelectorAll('.recurring-log-item select[data-type]').forEach(select => {
          const defaultValue = select.dataset.default;
          if (defaultValue !== undefined) {
              select.value = defaultValue;
          }
      });
      // --- END NEW ---

      // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
      document.getElementById("export-btn").onclick = () => {
        const blob = new Blob([JSON.stringify({ 
          days: state.days, 
          categories: state.categories, 
          recurringLogs: state.recurringLogs,
          reviewCriteria: state.reviewCriteria, // â˜…NEW: åŸºæº–ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        }, null, 2)], {type:"application/json"}); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "life_ownership_data_v10.json"; 
        a.click();
        URL.revokeObjectURL(url);
      };

      document.getElementById("clear-btn").onclick = async () => {
        const confirmed = confirm("æœ¬å½“ã«å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ“ä½œã¯**ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆSupabaseï¼‰ã®ä¸¡æ–¹**ã®è¨˜éŒ²ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ï¼ˆã‚«ãƒ†ã‚´ãƒªè¨­å®šã¨ç¹°ã‚Šè¿”ã—ãƒ­ã‚°è¨­å®šã€æŒ¯ã‚Šè¿”ã‚ŠåŸºæº–ã¯æ®‹ã‚Šã¾ã™ï¼‰");

        if (!confirmed) {
          return;
        }
        
        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        state.days = {};
        saveDays(state.days);
        
        // 2. ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        await deleteAllCloudData();
        
        // 3. ç”»é¢ã‚’æ›´æ–°
        render();
        alert('âœ… å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      };
    }

    function render() {
      const loadingEl = document.getElementById('loading-overlay');
      if (loadingEl) {
        loadingEl.remove();
        document.getElementById('app').style.opacity = 1;
      }
      
      switch (state.currentTab) {
        case "today":
          renderToday();
          break;
        case "calendar":
          renderCalendar();
          break;
        case "stats":
          renderStats();
          break;
        case "logs":
          renderLogs();
          break;
        case "settings":
          renderSettings();
          break;
      }
    }

    // =======================================================
    // ======== ã‚¢ãƒ—ãƒªåˆæœŸåŒ–å‡¦ç† (7/10) - å¤‰æ›´ãªã— ========
    // =======================================================
    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('app').style.opacity = 0;
        document.body.insertAdjacentHTML('afterbegin', `
          <div id="loading-overlay" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); color:var(--text-muted); display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:9999;">
            <p>ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</p>
          </div>
        `);

        const mergedDays = await loadDays(); 
        state.days = mergedDays;

        const syncBtn = document.getElementById('saveButton');
        if (syncBtn) {
            syncBtn.addEventListener('click', syncAllLocalDataToSupabase);
            syncBtn.textContent = 'âš¡ å…¨è¨˜éŒ²ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸ'; 
        }

        render(); 
    });
    // =======================================================
  
// ===== v7 override: time block sheet with editable start/end =====
function openTimeBlockSheet(dateStr, startIdx, endIdx) {
    const d = new Date(dateStr);
    const dayData = withDefaults(state.days[dateStr], dateStr);
    const timeline = dayData.timeline;

    // current time range (for initial values)
    const startH = Math.floor(startIdx / 12);
    const startM = (startIdx % 12) * 5;
    const endH = Math.floor(endIdx / 12);
    const endM = (endIdx % 12) * 5;

    // helper to clamp minutes to 5-min steps
    function clampMinute(v) {
        let m = Math.round(v / 5) * 5;
        if (m < 0) m = 0;
        if (m > 55) m = 55;
        return m;
    }

    // helper: 24:00 ã‚’ 288 ã«ã€ãã‚Œä»¥å¤–ã¯ hmToIndex ã‚’ä½¿ã†
    function hmToIndexSafe(h, m) {
        if (h === 24 && m === 0) return 288;
        if (h < 0) h = 0;
        if (h > 23) h = 23;
        m = clampMinute(m);
        return hmToIndex(h, m);
    }

    const overlay = document.createElement("div");
    overlay.className = "sheet-backdrop";

    // HTML: ã€Œé–‹å§‹ 99:99 ã‹ã‚‰ 99:99 ã®é–“ã€ã®å½¢ã¯æ®‹ã—ã¤ã¤ã€æ•°å­—ã ã‘å…¥åŠ›æ¬„ã«ã™ã‚‹
    overlay.innerHTML = `
        <div class="sheet" style="max-height: 70vh;">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <h3>${dateStr}</h3>
                <button class="sheet-close">âœ•</button>
            </div>
            <div class="card" style="margin-bottom:10px;">
                <div class="section-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†</div>
                <p class="muted" style="font-size:11px; display:flex; flex-wrap:wrap; align-items:center; gap:4px;">
                    é–‹å§‹ 
                    <input id="start-hour-input" type="number" min="0" max="24" step="1" 
                           value="${String(startH).padStart(2, '0')}" 
                           style="width:42px; text-align:right; font-size:11px; padding:2px 4px; border-radius:4px; border:1px solid rgba(148,163,184,0.5); background:#020617; color:var(--text-main);">
                    :
                    <input id="start-minute-input" type="number" min="0" max="55" step="5" 
                           value="${String(startM).padStart(2, '0')}" 
                           style="width:34px; text-align:right; font-size:11px; padding:2px 4px; border-radius:4px; border:1px solid rgba(148,163,184,0.5); background:#020617; color:var(--text-main);">
                    ã‹ã‚‰
                    <input id="end-hour-input" type="number" min="0" max="24" step="1" 
                           value="${endIdx === 288 ? '24' : String(endH).padStart(2, '0')}" 
                           style="width:42px; text-align:right; font-size:11px; padding:2px 4px; border-radius:4px; border:1px solid rgba(148,163,184,0.5); background:#020617; color:var(--text-main);">
                    :
                    <input id="end-minute-input" type="number" min="0" max="55" step="5" 
                           value="${endIdx === 288 ? '00' : String(endM).padStart(2, '0')}" 
                           style="width:34px; text-align:right; font-size:11px; padding:2px 4px; border-radius:4px; border:1px solid rgba(148,163,184,0.5); background:#020617; color:var(--text-main);">
                    ã®é–“
                </p>
                <div class="field-label" style="margin-top:10px;">ã‚«ãƒ†ã‚´ãƒª</div>
                <select id="block-category-select" class="headline-input">
                    <option value="null">æœªè¨­å®šï¼ˆç©ºãæ™‚é–“ï¼‰</option>
                    ${state.categories.map(c => 
                        `<option value="${c.id}" ${timeline[startIdx] === c.id ? 'selected' : ''}>${c.name}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="save-row">
                <button class="btn btn-primary" id="save-block-btn">ä¿å­˜</button>
            </div>
        </div>
    `;

    document.body.appendChild(overlay);

    const close = () => {
        document.body.removeChild(overlay);
    };

    overlay.querySelector(".sheet-close").onclick = close;
    overlay.addEventListener("click", (e) => {
        if (e.target === overlay) close();
    });

    overlay.querySelector("#save-block-btn").onclick = async () => {
        const sh = Number(document.getElementById("start-hour-input").value);
        const sm = Number(document.getElementById("start-minute-input").value);
        const eh = Number(document.getElementById("end-hour-input").value);
        const em = Number(document.getElementById("end-minute-input").value);

        // åˆ†ã¯ 5åˆ†åˆ»ã¿ã«ä¸¸ã‚ã‚‹
        const startIdxNew = hmToIndexSafe(sh, sm);
        const endIdxNew   = hmToIndexSafe(eh, em);

        if (isNaN(startIdxNew) || isNaN(endIdxNew)) {
            alert("æ™‚åˆ»ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
            return;
        }
        if (startIdxNew >= endIdxNew) {
            alert("çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const newCatIdRaw = document.getElementById("block-category-select").value;
        const newCatId = newCatIdRaw === "null" ? null : newCatIdRaw;

        for (let i = startIdxNew; i < endIdxNew && i < 288; i++) {
            timeline[i] = newCatId;
        }

        dayData.timeline = timeline;
        state.days[dateStr] = dayData;
        saveDays(state.days);
        await saveDailyData(dateStr);

        close();
        renderCalendarDay();
    };
}

</script>
</body>
</html>
